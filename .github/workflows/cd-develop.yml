name: CI/CD

on:
  push:
    branches: [ "feature/seungmin" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read


jobs:
  # 1. ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
  build-docker-image:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Create application.yml from secrets
        run: |
          mkdir -p src/main/resources
          echo "${{ secrets.APPLICATION_YML }}" > src/main/resources/application.yml

      - name: Copy keystore.p12
        run: |
          cd ./src/main/resources
          touch ./keystore.p12
          echo "${{secrets.KEYSTORE}}" | base64 --decode > ./keystore.p12

      - name: Build with Gradle
        uses: gradle/gradle-build-action@v2
        with:
          arguments: clean bootJar

      - name: Docker build with latest tag
        run: docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/github-actions-demo:latest .

      - name: Docker login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_ACCESS_TOKEN }}

      - name: Push Docker image
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/github-actions-demo:latest

  # 2. EC2ì—ì„œ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
  run-docker-image-on-ec2:
    needs: build-docker-image
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v3

      - name: Pull latest image from Docker Hub
        run: sudo docker pull ${{ secrets.DOCKERHUB_USERNAME }}/github-actions-demo:latest

      - name: Cleanup all existing containers before starting
        run: |
          echo "ğŸ§¹ Cleaning up all existing containers"

          # Stop and remove specific containers
          sudo docker stop github-actions-demo || true
          sudo docker rm github-actions-demo || true

          sudo docker stop elasticsearch || true
          sudo docker rm elasticsearch || true


          echo "ğŸ§¯ Cleaning up unused Docker networks"
          sudo docker system prune -f || true

      - name: Create Docker network if not exists
        run: |
          sudo docker network create wayble-network || true

      - name: Check if Elasticsearch image exists locally
        run: |
          if sudo docker images | grep -q "es-with-nori.*9.0.2"; then
            echo "âœ… Elasticsearch image found locally - skipping download"
          else
            echo "â¬‡ï¸ Building Elasticsearch with Nori image..."
            sudo docker build -f Dockerfile.elasticsearch -t es-with-nori:9.0.2 .
          fi

      - name: Run Elasticsearch container
        run: |
          sudo docker run -d \
            --name elasticsearch \
            --network wayble-network \
            -p 9200:9200 -p 9300:9300 \
            -e "discovery.type=single-node" \
            -e "xpack.security.enabled=false" \
            -e "network.host=0.0.0.0" \
            -e "ES_JAVA_OPTS=-Xms384m -Xmx384m" \
            -v elasticsearch-data:/usr/share/elasticsearch/data \
            es-with-nori:9.0.2

      - name: Wait for test Elasticsearch to be ready
        run: |
          echo "Waiting for test Elasticsearch to start..."
          for i in {1..30}; do
            HEALTH_STATUS=$(curl -s http://localhost:9200/_cluster/health | jq -r '.status' 2>/dev/null || echo "down")
            if [ "$HEALTH_STATUS" = "green" ] || [ "$HEALTH_STATUS" = "yellow" ]; then
              echo "âœ… Test Elasticsearch is ready and healthy! Status: $HEALTH_STATUS"
              curl -s http://localhost:9200/_cluster/health | jq .
              break
            fi
            echo "Waiting... ($i/30) - Current status: $HEALTH_STATUS"
            sleep 5
          done

      - name: Verify network connectivity
        run: |
          echo "=== Network Information ==="
          sudo docker network inspect wayble-network

          echo "=== Test DNS resolution from Spring Boot container ==="
          sudo docker run --rm --network wayble-network alpine:latest nslookup elasticsearch || echo "DNS resolution failed"

          echo "=== Test ping from Spring Boot container ==="
          sudo docker run --rm --network wayble-network alpine:latest ping -c 2 elasticsearch || echo "Ping failed"

          echo "=== Test direct HTTP connection from container ==="
          sudo docker run --rm --network wayble-network alpine/curl:latest curl -v http://elasticsearch:9200/_cluster/health || echo "HTTP connection failed"

          echo "=== Test Elasticsearch from same network context ==="
          sudo docker run --rm --network wayble-network alpine/curl:latest curl -s http://elasticsearch:9200/_cluster/health | jq . || echo "JSON parsing failed"


      - name: Run new Spring Boot container
        run: |
          sudo docker run -d \
            --name github-actions-demo \
            --network wayble-network \
            -p 8080:8080 \
            -e "SPRING_PROFILES_ACTIVE=develop" \
            ${{ secrets.DOCKERHUB_USERNAME }}/github-actions-demo:latest

      - name: Test application health
        run: |
          echo "Waiting for application to start..."
          sleep 30

          # ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ í™•ì¸
          echo "=== Application Logs ==="
          sudo docker logs github-actions-demo || echo "Failed to get app logs"

          # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
          echo "=== Container Status ==="
          sudo docker ps -a --filter "name=github-actions-demo"

          # í¬íŠ¸ í™•ì¸
          echo "=== Port Check ==="
          netstat -tlnp | grep 8080 || echo "Port 8080 not listening"

          # ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ì²´í¬ (ìƒì„¸ ë””ë²„ê·¸)
          echo "=== Health Check Details ==="
          curl -v http://localhost:8080/ || echo "Health check failed with exit code $?"

          # ê°„ë‹¨í•œ ì—°ê²° í…ŒìŠ¤íŠ¸
          echo "=== Simple Connection Test ==="
          timeout 5 bash -c 'cat < /dev/null > /dev/tcp/localhost/8080' && echo "Port 8080 is open" || echo "Port 8080 is closed"

          echo "âœ… Debug information collected"

          # Elasticsearch ì—°ê²° í…ŒìŠ¤íŠ¸
          if curl -f http://localhost:9200/_cluster/health > /dev/null 2>&1; then
            echo "âœ… Elasticsearch is accessible!"
          else
            echo "âŒ Elasticsearch connection failed"
            exit 1
          fi

      # âœ… ë°°í¬ ì„±ê³µ ì•Œë¦¼ (Discord)
#      - name: Send success webhook to Discord
#        if: success()
#        run: |
#          curl -H "Content-Type: application/json" \
#               -X POST \
#               -d "{\"content\": \"âœ… EC2 ë°°í¬ ì„±ê³µ! (ë¸Œëœì¹˜: develop)\"}" \
#               ${{ secrets.DISCORD_WEBHOOK_URL }}
#
#      # âŒ ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼ (Discord)
#      - name: Send failure webhook to Discord
#        if: failure()
#        run: |
#          curl -H "Content-Type: application/json" \
#               -X POST \
#               -d "{\"content\": \"âŒ EC2 ë°°í¬ ì‹¤íŒ¨! í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.\"}" \
#               ${{ secrets.DISCORD_WEBHOOK_URL }}




# on:  #ì´ ì›Œí¬í”Œë¡œìš°ê°€ ì–¸ì œ ì‹¤í–‰ë ì§€ íŠ¸ë¦¬ê±°ë¥¼ ì •ì˜í•¨.
#   pull_request:
#     types : [closed] #ëˆ„êµ°ê°€ê°€ Pull requestë¥¼ ë‹«ì•˜ì„ ë•Œ ì‹¤í–‰ë¨.
#   workflow_dispatch: #ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥í•˜ë„ë¡

# jobs: #ì‹¤ì œ ì‹¤í–‰í•  ì‘ì—…ì„ ì •ì˜
#   build: #ì‘ì—… ì´ë¦„
#     runs-on: ubuntu-latest #OSí™˜ê²½
#     if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'develop'
#     #ë‹«íŒ Pull Request ì¤‘ì—ì„œ, ë³‘í•©ëœ ê²ƒì´ê³ , ë³‘í•© ëŒ€ìƒ ë¸Œëœì¹˜ê°€ develop ë¸Œëœì¹˜ì¼ ê²½ìš°ì—ë§Œ ì´ ì‘ì—…ì„ ì‹¤í–‰



